name: Continuous Integration
on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main

    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            image_tag: ${{ steps.meta.outputs.image_tag }}
        steps:
            - uses: actions/checkout@v6.0.1

            - name: Set up Hugo
              uses: peaceiris/actions-hugo@v3.0.0
              with:
                  hugo-version: "0.152.2"

            - name: Compute image tag
              id: meta
              run: echo "image_tag=${{ vars.REGISTRY_USER }}/blog:${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

            - name: Build blog and package Docker image
              run: |
                  hugo --minify
                  ls -lha public/
                  docker build -t ${{ steps.meta.outputs.image_tag }} .

            - name: Push Docker image
              run: |
                  echo "${{ secrets.ACCESS_TOKEN }}" | docker login -u ${{ vars.REGISTRY_USER }} --password-stdin
                  docker push ${{ steps.meta.outputs.image_tag }}

    deploy:
        needs: build
        uses: hanatole/deployment/.github/workflows/cd.yml@main
        with:
            project_directory: "/srv/blog"
            traefik_rule: "Host(`ah.imc.chillo.fr`)"
            network_name: traefiknetwork
            service_name: blog
            service_port: 80
            docker_image: ${{ needs.build.outputs.image_tag }}
        secrets: inherit
